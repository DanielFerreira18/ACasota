@page "/AdoptionForm/{id}"
@using System.Collections
@using ACasotaBlazorServer.Data
@using Microsoft.AspNetCore.Identity;
@using Microsoft.EntityFrameworkCore;
@inject UserManager<ApplicationUser> _userManager
@inject NavigationManager nav
@inject IDbContextFactory<DataContext> contextDb
@inject IWebHostEnvironment enviroment
@inject IJSRuntime JSRuntime

@attribute [Authorize]

<PageTitle>Perfil</PageTitle>

<AuthorizeView>
    <Authorized>
        @if (render)
        {
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center py-3">
                <div class="d-block mb-4 mb-md-0">
                    <nav aria-label="breadcrumb" class="d-none d-md-inline-block">
                        <ol class="breadcrumb breadcrumb-dark breadcrumb-transparent">
                            <li class="breadcrumb-item">
                                <a href="/">
                                    <svg class="icon icon-xxs" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                                </a>
                            </li>
                            <li class="breadcrumb-item"><a href="/">ACasota</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Perfil</li>
                        </ol>
                    </nav>
                    <h2 class="h4">Perfil de Utilizador</h2>
                    <p class="mb-0">Página de especificações e caracteristicas do utilizador</p>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-12 col-xl-6">
                    <div class="card card-body border-0 shadow mb-4">
                        <h2 class="h5 mb-4">Informação do Animal</h2>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div>
                                    <img class="img-fluid rounded-bottom rounded-top" src="@profileAnimalPic" alt="Card image cap">
                                </div>
                            </div>
                            <div class="col-md-9 mb-3">
                                <div class="form-group">
                                    <label for="AnimalName">Nome do Animal</label>
                                    <label class="form-control" id="AnimalName">@user_auth.Animal.Name</label>
                                </div>
                                <div class="form-group">
                                    <label for="AnimalRace">Espécie do Animal</label>
                                    @if (@user_auth.Animal.Race == "Dog")
                                    {
                                        <label class="form-control" id="AnimalRace">Cão</label>
                                    }
                                    else
                                    {
                                        <label class="form-control" id="AnimalRace">Gato</label>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="AnimalAge">Idade do Animal</label>
                                    @if (@user_auth.Animal.Age == "Baby")
                                    {
                                        <label class="form-control" id="AnimalAge">Bebe</label>
                                    }
                                    else if (@user_auth.Animal.Age == "Junior")
                                    {
                                        <label class="form-control" id="AnimalAge">Junior</label>
                                    }
                                    else if (@user_auth.Animal.Age == "Adult")
                                    {
                                        <label class="form-control" id="AnimalAge">Adulto</label>
                                    }
                                    else
                                    {
                                        <label class="form-control" id="AnimalAge">Sénior</label>
                                    }
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="AnimalSex">Género do Animal</label>
                                    @if (@user_auth.Animal.Sex == "Female")
                                    {
                                        <label class="form-control" id="AnimalSex">Fêmea</label>
                                    }
                                    else
                                    {
                                        <label class="form-control" id="AnimalSex">Macho</label>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label for="AnimalSize">Porte do Animal</label>
                                    @if (@user_auth.Animal.Size == "Little")
                                    {
                                        <label class="form-control" id="AnimalSize">Pequeno</label>
                                    }
                                    else @if (@user_auth.Animal.Size == "Medium")
                                    {
                                        <label class="form-control" id="AnimalSize">Médio</label>
                                    }
                                    else
                                    {
                                        <label class="form-control" id="AnimalSize">Grande</label>
                                    }
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label for="AnimalVac">Vacinação</label>
                                    @if (@user_auth.Animal.IsVacinated)
                                    {
                                        <label class="form-control" id="AnimalVac">Regularizada</label>
                                    }
                                    else
                                    {
                                        <label class="form-control" id="AnimalVac">Não Regularizada</label>
                                    }
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label for="AnimalSteril">Esterelização</label>
                                    @if (@user_auth.Animal.IsSterile)
                                    {
                                        <label class="form-control" id="AnimalSteril">Esterelizado</label>
                                    }
                                    else
                                    {
                                        <label class="form-control" id="AnimalSteril">Não Esterelizado</label>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xl-6">
                    <div class="card card-body border-0 shadow mb-4">
                        <h2 class="h5 mb-4">Informação do Utilizador</h2>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div>
                                    <img class="img-fluid rounded-bottom rounded-top" src="@profileUserPic" alt="Card image cap">
                                </div>
                            </div>
                            <div class="col-md-9 mb-3">
                                <div class="form-group">
                                    <label for="UserFirstName">Primeiro Nome</label>
                                    <label class="form-control" id="UserFirstName">@user_auth.User.FirstName</label>
                                </div>
                                <div class="form-group">
                                    <label for="UserLastName">Apelido</label>
                                    <label class="form-control" id="UserLastName">@user_auth.User.LastName</label>
                                </div>
                            </div>
                        </div>
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="UserEmail">Email</label>
                                    <label class="form-control" id="UserEmail">@user_auth.User.Email</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="UserNumber">Numero de Telemóvel</label>
                                    @if (user_auth.User.PhoneNumber == "" || user_auth.User.PhoneNumber == null)
                                    {
                                        <label class="form-control text-danger" id="UserNumber">Não tem numero de telemovel</label>
                                    }
                                    else
                                    {
                                        <label class="form-control" id="UserNumber">@user_auth.User.PhoneNumber</label>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label for="UserCCNumber">Cartão de Cidadão</label>
                                    @if (user_auth.User.CCnumber == "" || user_auth.User.CCnumber == null)
                                    {
                                        <label class="form-control text-danger" id="UserCCNumber">Não tem numero de CC</label>
                                    }
                                    else
                                    {
                                        <label class="form-control" id="UserCCNumber">@user_auth.User.CCnumber</label>
                                    }
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label for="UserNIF">NIF</label>
                                    @if (user_auth.User.Nif == "" || user_auth.User.Nif == null)
                                    {
                                        <label class="form-control text-danger" id="UserNIF">Não tem NIF</label>
                                    }
                                    else
                                    {
                                        <label class="form-control" id="UserNIF">@user_auth.User.Nif</label>
                                    }
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label for="UserSex">Género</label>
                                    @if (@user_auth.User.Sex == "Female")
                                    {
                                        <label class="form-control" id="UserSex">Feminino</label>
                                    }
                                    else
                                    {
                                        <label class="form-control" id="UserSex">Masculino</label>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xl-12" id="tableWidth">
                    <div class="card card-body border-0 shadow mb-4">
                        <div class="row">
                            <div class="col-md-12">
                                <h2 class="h5 mb-4">Informação do Formulário de Adoção</h2>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="UserAddress">Morada</label>
                                            @if (user_auth.User.Nif == "" || user_auth.User.Nif == null)
                                            {
                                                <label class="form-control text-danger" id="UserAddress">Não tem morada</label>
                                            }
                                            else
                                            {
                                                <label class="form-control" id="UserAddress">@user_auth.User.Address</label>
                                            }
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="UserHouseType">Tipo de Habitação</label>
                                            <label class="form-control" id="UserHouseType">@adoptionHouse.Type.Type</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="UserHouseTipology">Tipologia de Habitação</label>
                                            <label class="form-control" id="UserHouseTipology">@adoptionHouse.Tipology</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="UserCity">Cidade</label>
                                            @if (user_auth.User.Nif == "" || user_auth.User.Nif == null)
                                            {
                                                <label class="form-control text-danger" id="UserCity">Não especifica cidade</label>
                                            }
                                            else
                                            {
                                                <label class="form-control" id="UserCity">@user_auth.User.City</label>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h2 class="h5 my-4">Informação de animais existentes</h2>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="HasAnimal">Possui animais</label>
                                        @if (user_auth.HasAnimals)
                                        {
                                            <label class="form-control" id="HasAnimal">Sim</label>
                                        }
                                        else
                                        {
                                            <label class="form-control" id="HasAnimal">Não</label>
                                        }
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <label for="DescAnimal">Descrição dos animais do utilizador</label>
                                    <label class="form-control" style="height: 100px;" placeholder="Descrição..." id="DescAnimal" rows="4">@user_auth.AnimalDescription</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h2 class="h5 my-4">Consentimento e responsabilização</h2>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="Consent">Consentimento da responsabilidade</label>
                                        @if (user_auth.ConsentResponsability)
                                        {
                                            <label class="form-control" id="Consent">Consentido</label>
                                        }
                                        else
                                        {
                                            <label class="form-control" id="Consent">Não Consentido</label>
                                        }
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <label for="ReasonAdoption">Razão de Adoção</label>
                                    <label class="form-control" style="height: 100px;" placeholder="Descrição..." id="ReasonAdoption" rows="4">@user_auth.AdoptionReason</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                @if (isAdmin)
                {
                    @if (user_auth.State == 2)
                    {
                        <div class="form-group d-flex justify-content-center">
                            <button type="button" id="bts" class="ms-2 btn large-form-btn btn-success" @onclick="AceptForm">Aceitar Pedido</button>
                            <button type="button" id="bts" class="ms-2 btn large-form-btn btn-danger" @onclick="RejectForm">Rejeitar Pedido</button>
                        </div>
                    }
                }
            </div>
        }
    </Authorized>
</AuthorizeView>

@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthenticationStateTask { get; set; }

    [Parameter]
    public string? id { get; set; }

    public Adoption user_auth { get; set; } = new Adoption();
    public AdoptionHouse adoptionHouse { get; set; } = new AdoptionHouse();

    private bool render = false;
    private bool isAdmin = false;

    private bool errorHandling = true;

    //List of extentions
    public List<string> imageExtensions = new List<string> { ".jpg", ".jpeg", ".png" };

    //Bool control extention
    public bool hasExtention = false;

    private string pathRoot = "";
    private string pathPicsRoot = "..\\users_pics";
    private string pathPicsRootAnimal = "";
    private string pathPicsRootUser = "";
    private string profileUserPic = "";
    private string profileAnimalPic = "";
    private long maxFileSize = 1024 * 1024 * 3;

    //Methods
    protected override async Task OnInitializedAsync()
    {
        pathRoot = Path.Combine(enviroment.ContentRootPath, "wwwroot", "users_pics");

        var authState = await AuthenticationStateTask;
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            using (var ctx = contextDb.CreateDbContext())
            {
                user_auth = await ctx.Adoptions.Where(u => u.Id.Equals(this.id)).Include(c => c.User).Include(a => a.Animal).FirstAsync();
                adoptionHouse = await ctx.AdoptionHouses.Where(ah => ah.Id.Equals(user_auth.HouseId)).Include(c => c.Type).FirstAsync();

                if (user.IsInRole("Admin") || user.IsInRole("AdminPartner"))
                {
                    isAdmin = true;
                }

                render = true;

                pathPicsRootUser = Path.Combine(pathPicsRoot, user_auth.User.UserName);
                pathPicsRootAnimal = Path.Combine(pathPicsRoot, user_auth.Animal.Id);

                if (user_auth.User.ProfilePic != null && File.Exists(Path.Combine(pathRoot, user_auth.User.UserName, user_auth.User.ProfilePic)))
                {
                    profileUserPic = Path.Combine(pathPicsRootUser, user_auth.User.ProfilePic);
                }
                else
                {
                    profileUserPic = "..\\assets\\img\\userDefault\\userDefault.jpg";
                }

                if (user_auth.Animal.AnimalPicture != null && File.Exists(Path.Combine(pathRoot, user_auth.Animal.Id, user_auth.Animal.AnimalPicture)))
                {
                    profileAnimalPic = Path.Combine(pathPicsRootAnimal, user_auth.Animal.AnimalPicture);
                }
                else
                {
                    profileAnimalPic = "..\\assets\\img\\userDefault\\userDefault.jpg";
                }
            }
        }
    }

    public void Navs()
    {
        nav.NavigateTo("/AdoptionManagement", true);
    }

    public async Task AceptForm()
    {
        using (var ctx = contextDb.CreateDbContext())
        {
            user_auth.State = 1;

            user_auth.Animal.UserId = user_auth.UserId;

            ctx.Animals.Update(user_auth.Animal);
            ctx.Adoptions.Update(user_auth);
            await ctx.SaveChangesAsync();
        }

        Navs();
    }

    public async Task RejectForm()
    {
        using (var ctx = contextDb.CreateDbContext())
        {
            user_auth.State = 0;

            ctx.Adoptions.Update(user_auth);
            await ctx.SaveChangesAsync();
        }

        Navs();
    }
}