@page "/Profile"
@using System.Collections
@using ACasotaBlazorServer.Data
@using Microsoft.AspNetCore.Identity;
@using Microsoft.EntityFrameworkCore;
@inject UserManager<ApplicationUser> _userManager
@inject IDbContextFactory<DataContext> contextDb
@attribute [Authorize]

<PageTitle>Perfil</PageTitle>

<AuthorizeView>
	<Authorized>
		<h1>Perfil</h1>
		<section style="background-color: #eee;">
			<div class="container py-5">
				<div class="row">
					<div class="col">
						<nav aria-label="breadcrumb" class="bg-light rounded-3 p-3 mb-4">
							<ol class="breadcrumb mb-0">
								<li class="breadcrumb-item"><a href="/">Página Principal</a></li>
								<li class="breadcrumb-item active" aria-current="page">Perfil</li>
							</ol>
						</nav>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-4">
						<div class="card mb-4">
							<div class="card-body text-center">
								<img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3.webp" alt="avatar"
									 class="rounded-circle img-fluid" style="width: 150px;">
								<h5 class="my-3">@user_auth.FirstName @user_auth.LastName</h5>
							</div>
						</div>
					</div>
					<div class="col-lg-8">
						<div class="card mb-4">
							<div class="card-body">
								<div class="row">
									<div class="col-sm-3">
										<p class="mb-0">Nome Completo</p>
									</div>
									<div class="col-sm-9">
										<input type="text" class="form-control" placeholder="Primeiro Nome" onfocusout="checkFirstName()" onkeyup="checkFirstName()" value="@user_auth.FirstName" id="firstname" required>
									</div>
								</div>
								<hr>
								<div class="row">
									<div class="col-sm-3">
										<p class="mb-0">Ultimo Nome</p>
									</div>
									<div class="col-sm-9">
										<input type="text" class="form-control" placeholder="Ultimo Nome" onfocusout="checkLastName()" onkeyup="checkLastName()" value="@user_auth.LastName" id="lastname" required>
									</div>
								</div>
								<hr>
								<div class="row">
									<div class="col-sm-3">
										<p class="mb-0">Email</p>
									</div>
									<div class="col-sm-9">
										<input type="email" class="form-control" placeholder="Email" onfocusout="checkEmail()" onkeyup="checkEmail()" value="@user_auth.Email" id="email" required>
									</div>
								</div>
								<hr>
								<div class="row">
									<div class="col-sm-3">
										<p class="mb-0">Telemóvel</p>
									</div>
									<div class="col-sm-9">
										<input type="text" class="form-control" placeholder="" onfocusout="" onkeyup="" value="@user_auth.PhoneNumber" id="telemovel">
									</div>
								</div>
								<hr>
								<div class="row">
									<div class="col-sm-3">
										<p class="mb-0">Morada</p>
									</div>
									<div class="col-sm-9">
										<input type="text" class="form-control" placeholder="" onfocusout="" onkeyup="" value="@user_auth.Address" id="morada">
									</div>
								</div>
								<hr>
								<div class="row">
									<div class="col-sm-3">
										<p class="mb-0">Numero de CC</p>
									</div>
									<div class="col-sm-9">
										<input type="text" class="form-control" placeholder="" onfocusout="" onkeyup="" value="@user_auth.CCnumber" id="ccnumber">
									</div>
								</div>
								<hr>
								<div class="row">
									<div class="col-sm-3">
										<p class="mb-0">NIF</p>
									</div>
									<div class="col-sm-9">
										<input type="text" class="form-control" placeholder="" onfocusout="" onkeyup="" value="@user_auth.Nif" id="NIF">
									</div>
								</div>
							</div>
						</div>
						<div id="addEventForm">
							<a class="btn btn-pill btn-outline-primary" href="/Profile">Editar Conta</a>
						</div>
					</div>
				</div>
			</div>
		</section>
	</Authorized>
	<NotAuthorized>
		<p role="status">You are not authorized to see this component</p>
	</NotAuthorized>
</AuthorizeView>

@code {
	[CascadingParameter]
	public Task<AuthenticationState> AuthenticationStateTask { get; set; }
	public ApplicationUser user_auth { get; set; } = new ApplicationUser();
	public string random = "";

	protected override async Task OnInitializedAsync()
	{
		var authState = await AuthenticationStateTask;
		var user = authState.User;

		if (user.Identity.IsAuthenticated)
		{
			using (var ctx = contextDb.CreateDbContext())
			{
				user_auth = await ctx.Users.SingleAsync(u => u.UserName.Equals(user.Identity.Name));
			}
		}
	}
}