@page "/UserManagement"
@using System.Collections
@using ACasotaBlazorServer.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore

@inject IDbContextFactory<DataContext> contextDb

@attribute [Authorize]

<PageTitle>Gestão de Utilizadores</PageTitle>
<AuthorizeView Roles ="Admin">
	<Authorized>
		<h1>Lista de utilizadores</h1>
		<table class="table">
			<thead>
				<tr>
					<th>Primeiro Nome</th>
					<th>Ultimo Nome</th>
					<th>Email</th>
					<th>Data de Nascimento</th>
					<th>Ações</th>
				</tr>
			</thead>
			<tbody>
				@foreach (var userDb in users)
				{
						<tr>
							<td>@userDb.FirstName</td>
							<td>@userDb.LastName</td>
							<td>@userDb.Email</td>
							<td>@userDb.Date_Birth.Date</td>
							<td>
								@if (userDb.IsEnabled)
								{
									<button class="btn btn-pill btn-danger" @onclick="() => blockUser(userDb.Id, userDb.IsEnabled)">Bloquear</button>
								}
								else
								{
									<button class="btn btn-pill btn-outline-danger" @onclick="() => blockUser(userDb.Id, userDb.IsEnabled)">Desbloquear</button>
								}
								<a class="btn btn-pill btn-primary" href="/UserEdit/@userDb.Id">Editar</a>
							</td>
						</tr>
				}
			</tbody>
		</table>

        <div class="card border-0 shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-centered table-nowrap mb-0 rounded">
                        <thead class="thead-light">
                            <tr>
                                <th class="border-0 rounded-start">Utilizador</th>
                                <th class="border-0">E-mail</th>
                                <th class="border-0">Telemóvel</th>
                                <th class="border-0">NIF</th>
                                <th class="border-0">Morada</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Item -->
                            <tr>
                                <td class="border-0">
                                    <a href="#" class="d-flex align-items-center">
                                        <img class="me-2 image image-small rounded-circle" alt="Image placeholder" src="../../assets/img/flags/united-states-of-america.svg">
                                        <div><span class="h6">United States</span></div>
                                    </a>
                                </td>
                                <td class="border-0 fw-bold">106</td>
                                <td class="border-0 text-danger">
                                    <div class="d-flex align-items-center">
                                        <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                        <span class="fw-bold">5</span>
                                    </div>
                                </td>
                                <td class="border-0 fw-bold">
                                    3
                                </td>
                                <td class="border-0">
                                    =
                                </td>
                            </tr>
                            <!-- End of Item -->
                            <!-- Item -->
                            <tr>
                                <td class="border-0">
                                    <a href="#" class="d-flex align-items-center">
                                        <img class="me-2 image image-small rounded-circle" alt="Image placeholder" src="../../assets/img/flags/canada.svg">
                                        <div><span class="h6">Canada</span></div>
                                    </a>
                                </td>
                                <td class="border-0 fw-bold">76</td>
                                <td class="border-0 text-success">
                                    <div class="d-flex align-items-center">
                                        <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                        <span class="fw-bold">17</span>
                                    </div>
                                </td>
                                <td class="border-0 fw-bold">
                                    4
                                </td>
                                <td class="border-0">
                                    =
                                </td>
                            </tr>
                            <!-- End of Item -->
                            <!-- Item -->
                            <tr>
                                <td class="border-0">
                                    <a href="#" class="d-flex align-items-center">
                                        <img class="me-2 image image-small rounded-circle" alt="Image placeholder" src="../../assets/img/flags/united-kingdom.svg">
                                        <div><span class="h6">United Kingdom</span></div>
                                    </a>
                                </td>
                                <td class="border-0 fw-bold">147</td>
                                <td class="border-0 text-success">
                                    <div class="d-flex align-items-center">
                                        <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                        <span class="fw-bold">10</span>
                                    </div>
                                </td>
                                <td class="border-0 fw-bold">
                                    5
                                </td>
                                <td class="border-0">
                                    =
                                </td>
                            </tr>
                            <!-- End of Item -->
                            <!-- Item -->
                            <tr>
                                <td class="border-0">
                                    <a href="#" class="d-flex align-items-center">
                                        <img class="me-2 image image-small rounded-circle" alt="Image placeholder" src="../../assets/img/flags/france.svg">
                                        <div><span class="h6">France</span></div>
                                    </a>
                                </td>
                                <td class="border-0 fw-bold">112</td>
                                <td class="border-0 text-success">
                                    <div class="d-flex align-items-center">
                                        <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                        <span class="fw-bold">3</span>
                                    </div>
                                </td>
                                <td class="border-0 fw-bold">
                                    5
                                </td>
                                <td class="border-0 text-success">
                                    <div class="d-flex align-items-center">
                                        <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                        <span class="fw-bold">1</span>
                                    </div>
                                </td>
                            </tr>
                            <!-- End of Item -->
                            <!-- Item -->
                            <tr>
                                <td class="border-0">
                                    <a href="#" class="d-flex align-items-center">
                                        <img class="me-2 image image-small rounded-circle" alt="Image placeholder" src="../../assets/img/flags/japan.svg">
                                        <div><span class="h6">Japan</span></div>
                                    </a>
                                </td>
                                <td class="border-0 fw-bold">115</td>
                                <td class="border-0 text-danger">
                                    <div class="d-flex align-items-center">
                                        <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                        <span class="fw-bold">12</span>
                                    </div>
                                </td>
                                <td class="border-0 fw-bold">
                                    6
                                </td>
                                <td class="border-0 text-danger">
                                    <div class="d-flex align-items-center">
                                        <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                        <span class="fw-bold">1</span>
                                    </div>
                                </td>
                            </tr>
                            <!-- End of Item -->
                            <!-- Item -->
                            <tr>
                                <td class="border-0">
                                    <a href="#" class="d-flex align-items-center">
                                        <img class="me-2 image image-small rounded-circle" alt="Image placeholder" src="../../assets/img/flags/germany.svg">
                                        <div><span class="h6">Germany</span></div>
                                    </a>
                                </td>
                                <td class="border-0 fw-bold">220</td>
                                <td class="border-0 text-danger">
                                    <div class="d-flex align-items-center">
                                        <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                        <span class="fw-bold">56</span>
                                    </div>
                                </td>
                                <td class="border-0 fw-bold">
                                    7
                                </td>
                                <td class="border-0 text-danger">
                                    <div class="d-flex align-items-center">
                                        <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                        <span class="fw-bold">3</span>
                                    </div>
                                </td>
                            </tr>
                            <!-- End of Item -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

	</Authorized>
	<NotAuthorized>
		<p role="status">Não tem autorização para aceder a esta página</p>
	</NotAuthorized>
</AuthorizeView>

@code {
	[CascadingParameter]
	public Task<AuthenticationState> AuthenticationStateTask { get; set; }
	public List<ApplicationUser> users { get; set; } = new List<ApplicationUser>();

	protected override async Task OnInitializedAsync()
	{
		var authState = await AuthenticationStateTask;
		var user = authState.User;

		if (user.Identity.IsAuthenticated)
		{
			using (var ctx = contextDb.CreateDbContext())
			{
				var usersCT = await ctx.Users.ToArrayAsync();

				foreach (var userct in usersCT)
				{
					users.Add(userct);
				}
			}
		}
	}

	public async Task blockUser(string id, bool enable)
	{
		using (var ctx = contextDb.CreateDbContext())
		{
			foreach (var user in users)
			{
				if (user.Id.Equals(id))
				{
					user.IsEnabled = !enable;
					ctx.Users.Update(user);

					await ctx.SaveChangesAsync();
				}
			}
		}
	}
}
